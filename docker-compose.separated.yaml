services:
  # Content Worker - Lightweight for text processing
  content-worker:
    build:
      context: .
      dockerfile: Dockerfile.content
    container_name: content-worker
    environment:
      # RabbitMQ Configuration
      RABBITMQ_URI: ${RABBITMQ_URI}

      # Storage Configuration
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      AZURE_INPUT_CONTAINER: ${AZURE_INPUT_CONTAINER}
      AZURE_OUTPUT_CONTAINER: ${AZURE_OUTPUT_CONTAINER}

      # Backend Communication
      BACKEND_API_BASE_URL: ${BACKEND_API_BASE_URL}
      BACKEND_API_KEY: ${BACKEND_API_KEY}

      # AI Configuration
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      DEFAULT_MODEL: ${DEFAULT_MODEL}

    volumes:
      - /etc/huytde_work/credentials:/app/credentials:ro

    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 600M # Lightweight content processing
          cpus: "0.75"
        reservations:
          memory: 300M
          cpus: "0.5"

  # Product Worker - Heavy for video/audio processing
  product-worker:
    build:
      context: .
      dockerfile: Dockerfile.product
    container_name: product-worker
    environment:
      # RabbitMQ Configuration
      RABBITMQ_URI: ${RABBITMQ_URI}

      # Storage Configuration
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      AZURE_INPUT_CONTAINER: ${AZURE_INPUT_CONTAINER}
      AZURE_OUTPUT_CONTAINER: ${AZURE_OUTPUT_CONTAINER}

      # Backend Communication
      BACKEND_API_BASE_URL: ${BACKEND_API_BASE_URL}
      BACKEND_API_KEY: ${BACKEND_API_KEY}

      # AI Configuration
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      DEFAULT_MODEL: ${DEFAULT_MODEL}

      # Product Worker Specific
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS}
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      UNSPLASH_ACCESS_KEY: ${UNSPLASH_ACCESS_KEY}

    volumes:
      - /etc/huytde_work/credentials:/app/credentials:ro
      - /tmp/video_temp:/tmp/video_temp

    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2.5G # Heavy video/audio processing
          cpus: "1.5"
        reservations:
          memory: 1G
          cpus: "1.0"
